<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bengaluru Heritage Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/marker-blink.css"/>
  <link rel="stylesheet" href="css/responsive.css"/>
    <link rel="stylesheet" href="css/panel-resize.css"/>
    <style>
      /* Custom modal backdrop to mask only below navbar */
      .custom-modal-backdrop {
        position: fixed;
        top: 75px; /* height of navbar */
        left: 0;
        width: 100vw;
        height: calc(100vh - 75px);
        background: rgba(0,0,0,0.5);
        z-index: 2000; /* Above sidepanels and map */
      }
      .modal.show {
        z-index: 2010;
      }
    </style>
  <!-- Leaflet.SidePanel plugin -->
  <link rel="stylesheet" href="dist/leaflet-sidepanel.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css"/>
</head>
<body>
  <!-- Custom Backdrop for Welcome Modal -->
  <div id="customModalBackdrop" class="custom-modal-backdrop" style="display:none;"></div>
  <!-- Welcome Modal -->
  <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="background:#f8f9fa;">
        <div class="modal-header" style="border-bottom:1px solid #ddd;">
          <h5 class="modal-title" id="welcomeModalLabel">Welcome to Bengaluru Heritage Sites</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div id="welcomeCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  <div class="carousel-item active">
                    <img src="assets/Mythic Society Logo.jpg" class="d-block w-100" alt="Logo" style="max-height:220px;object-fit:contain;">
                  </div>
                  <div class="carousel-item">
                    <img src="assets/photo1.jpg" class="d-block w-100" alt="Photo 1" style="max-height:220px;object-fit:cover;">
                  </div>
                  <div class="carousel-item">
                    <img src="assets/photo2.jpg" class="d-block w-100" alt="Photo 2" style="max-height:220px;object-fit:cover;">
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#welcomeCarousel" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#welcomeCarousel" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              </div>
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-center">
              <p style="font-size:1.1em;">Welcome! This site showcases Bengaluru's rich heritage: ancient temples, herostones, and inscriptions. Explore interactive maps, view 3D models, and discover the stories behind these monuments.</p>
              <ul style="font-size:0.98em;">
                <li>Interactive map of heritage sites</li>
                <li>3D digital conservation project</li>
                <li>Browse photos and details</li>
              </ul>
              <div style="margin-top:10px;">
                This Initiative is part of '<strong>The Mythic Society Bengaluru Inscriptions 3D Digital Conservation Project</strong>'
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-top:1px solid #ddd;">
          <div class="d-flex align-items-center w-100 justify-content-between">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dontShowWelcomeModal">
              <label class="form-check-label" for="dontShowWelcomeModal">Don't show again</label>
            </div>
            <div class="d-flex align-items-center">
              <div class="dropdown d-inline-block me-3">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="layerSelectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  Select sites...
                </button>
                <ul class="dropdown-menu" aria-labelledby="layerSelectDropdown">
                  <li>
                    <label class="dropdown-item">
                      <input type="checkbox" class="form-check-input me-2" id="welcomeLayerHerostones"> Herostones
                    </label>
                  </li>
                  <li>
                    <label class="dropdown-item">
                      <input type="checkbox" class="form-check-input me-2" id="welcomeLayerInscriptions"> Inscriptions
                    </label>
                  </li>
                  <li>
                    <label class="dropdown-item">
                      <input type="checkbox" class="form-check-input me-2" id="welcomeLayerTemples"> Temples
                    </label>
                  </li>
                  <li><small class="dropdown-item text-muted">You can also select layers later from the Layer Panel.</small></li>
                </ul>
              </div>
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var welcomeModalEl = document.getElementById('welcomeModal');
      var customBackdrop = document.getElementById('customModalBackdrop');
      var welcomeModal = new bootstrap.Modal(welcomeModalEl);
      // Only show modal if not suppressed for this session
      if (!sessionStorage.getItem('hideWelcomeModal')) {
        welcomeModal.show();
      }
      // Show custom backdrop when modal is shown
      welcomeModalEl.addEventListener('shown.bs.modal', function() {
        customBackdrop.style.display = '';
      });
      // Hide custom backdrop when modal is hidden
      welcomeModalEl.addEventListener('hidden.bs.modal', function() {
        customBackdrop.style.display = 'none';
        // Move focus to About button to avoid aria-hidden warning
        var aboutBtn = document.getElementById('aboutBtn');
        if (aboutBtn) {
          aboutBtn.focus();
        } else {
          document.body.focus();
        }
      });
      var continueBtn = document.querySelector('#welcomeModal .btn-primary');
      continueBtn.addEventListener('click', function() {
        // If 'Don't show again' is checked, suppress modal for this session
        var dontShow = document.getElementById('dontShowWelcomeModal').checked;
        if (dontShow) {
          sessionStorage.setItem('hideWelcomeModal', '1');
        }
        // Sync layer selection to layer panel
        var herostones = document.getElementById('welcomeLayerHerostones').checked;
        var inscriptions = document.getElementById('welcomeLayerInscriptions').checked;
        var temples = document.getElementById('welcomeLayerTemples').checked;
        var layerHerostones = document.getElementById('layerHerostones');
        var layerInscriptions = document.getElementById('layerInscriptions');
        var layerTemples = document.getElementById('layerTemples');
        if (layerHerostones) layerHerostones.checked = herostones;
        if (layerInscriptions) layerInscriptions.checked = inscriptions;
        if (layerTemples) layerTemples.checked = temples;
        // Optionally, trigger layer loading logic if needed
        if (typeof setLayerVisibility === 'function') {
          setLayerVisibility('Herostones', herostones);
          setLayerVisibility('Inscriptions', inscriptions);
          setLayerVisibility('Temples', temples);
        }
      });
    });
  </script>
  <nav class="navbar navbar-expand-lg" style="z-index:1100; height:75px; min-height:75px; background:#72383d;">
    <div class="container-fluid d-flex align-items-center" style="height:75px;">
        <div class="d-flex align-items-center">
          <img src="assets/Mythic Society Logo.jpg" alt="Mythic Society Logo" style="height:60px; width:60px; margin-right:18px; vertical-align:middle; border-radius:50%; border:3px solid #fff; object-fit:cover; background:#72383d;">
          <div style="display:flex; flex-direction:column; justify-content:center; color:#fff;">
            <span style="font-size:1.5em; font-weight:600; line-height:1.25;">The Mythic Society</span>
            <span style="font-size:1em; font-weight:400; line-height:1.25;">Bengaluru Inscriptions 3D Digital Conservation Project</span>
          </div>
        </div>
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); display:flex; flex-direction:column; align-items:center; color:#fff; width:max-content;">
          <span style="font-size:1.35em; font-weight:600; line-height:1.4; text-align:center;">Bengaluru Heritage Sites</span>
          <span style="font-size:1em; font-weight:400; line-height:1.4; text-align:center;">Ancient Temples | Herostones | Inscriptions</span>
        </div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <!-- Navigation links removed -->
      </div>
    </div>
  </nav>

  <!-- Flex container for sidebar and main content -->
  <div id="appContainer">
  <!-- Left Sidebar removed -->
    <!-- Main content area: map and query section stacked vertically -->
    <div id="mainContent">
      <!-- Left SidePanel container for Leaflet.SidePanel plugin -->
      <!-- Left panel toggle button (always visible) -->
      <button id="panelLeftToggle" aria-label="Toggle left panel" style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:32px;height:48px;background:#2b2b2b;border-radius:0 5px 5px 0;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center;z-index:2002;cursor:pointer;transition:background 0.2s;">
        <span id="panelLeftArrow" style="display:inline-block;transition:transform 0.2s;font-size:1.5em;color:#fff;">&#x2A1E;</span>
      </button>
      <!-- Left SidePanel container for Leaflet.SidePanel plugin -->
      <div id="panelLeft" class="sidepanel" aria-label="left side panel" aria-hidden="true" style="left:-320px; top:75px; height:calc(100vh - 75px); position:absolute; z-index:1101;">
        <div class="sidepanel-inner-wrapper">
          <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
            <ul class="sidepanel-tabs">
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-layers">
                  <i class="bi bi-layers" style="font-size:1.5em;"></i>
                </a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-filters">
                  <i class="bi bi-funnel" style="font-size:1.5em;"></i>
                </a>
              </li>
            </ul>
          </nav>
          <div class="sidepanel-content-wrapper">
            <div class="sidepanel-content">
              <div class="sidepanel-tab-content" data-tab-content="tab-layers">
                <h4>Layers</h4>
                <div id="sidepanel-layers">
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Heritage Sites</h5>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerHerostones" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerHerostones">Herostones</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterHerostones">

                      </div>
                    </div>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerInscriptions" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerInscriptions">Inscriptions</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterInscriptions">

                      </div>
                    </div>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerTemples" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerTemples">Temples</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterTemples">

                      </div>
                    </div>
                  </div>
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Basemaps</h5>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapOSM" checked>
                      <label class="form-check-label" for="basemapOSM">OSM Standard</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapTerrain">
                      <label class="form-check-label" for="basemapTerrain">Terrain</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapSatellite">
                      <label class="form-check-label" for="basemapSatellite">Satellite</label>
                    </div>
                    <div style="margin-top:10px;">
                      <label for="basemapOpacity" style="font-size:0.95em;">Opacity</label>
                      <input type="range" id="basemapOpacity" min="0.2" max="1" step="0.01" value="1" style="width:100%;">
                    </div>
                  </div>
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Administration Boundaries</h5>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Districts</label>
                      <div id="districtDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="districtDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Districts</button>
                        <div id="districtDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;">
                          <!-- District options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Taluks</label>
                      <div id="talukDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="talukDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Taluks</button>
                        <div id="talukDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;max-height:none;">
                          <!-- Taluk options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Other</label>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="layerRidgeBengaluru">
                        <label class="form-check-label" for="layerRidgeBengaluru">Ridge (Bengaluru)</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-filters" style="display:none;">
                <h4>Filters</h4>
                <div id="sidepanel-filters">
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Common Filters</h5>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Districts (District_KGIS)</label>
                      <div id="filterDistrictDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="filterDistrictDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Districts</button>
                        <div id="filterDistrictDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;">
                          <!-- District options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Taluks (Taluk_KGIS)</label>
                      <div id="filterTalukDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="filterTalukDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Taluks</button>
                        <div id="filterTalukDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;max-height:60vh;overflow-y:auto;">
                          <!-- Taluk options will be injected by JS -->
                        </div>
                      </div>
                    </div>

                      <div class="mb-2">
                        <label style="font-size:0.98em;font-weight:500;">Period (Century) From: <span id="periodMinSliderValue" style="font-size:0.95em; color:#444;"></span></label>
                        <input type="range" class="form-range" id="periodMinSlider" min="0" max="100" step="1">
                      </div>
                      <div class="mb-2">
                        <label style="font-size:0.98em;font-weight:500;">Period (Century) To: <span id="periodMaxSliderValue" style="font-size:0.95em; color:#444;"></span></label>
                        <input type="range" class="form-range" id="periodMaxSlider" min="0" max="100" step="1">
                      </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Map container -->
      <div id="map"></div>
      <!-- Right Info SidePanel -->
  <div id="panelRight" class="sidepanel" aria-label="side panel" aria-hidden="true" style="right:-320px; top:56px; height:calc(100vh - 56px);">
        <!-- Vertical toggle button on left edge -->
          <button id="panelRightToggle" aria-label="Toggle right panel" style="position:absolute;left: -32px ;top:50%;transform:translateY(-50%);width:32px;height:48px;background:#2b2b2b;border-radius: 5px 0 0 5px;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center;z-index:1002;cursor:pointer;transition:background 0.2s;">
          <span id="panelRightArrow" style="display:inline-block;transition:transform 0.2s;font-size:1.5em;">
            <span style="color:#fff;">&#x2A1E;</span>
          </span>
        </button>
        <div class="sidepanel-inner-wrapper">
          <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
            <ul class="sidepanel-tabs">
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1">About</a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-2">Features</a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-3">Wikipedia</a>
              </li>
              <li class="sidepanel-tab sidepanel-tab-hidden" style="display:none;">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-4">Photos</a>
              </li>
              <li class="sidepanel-tab sidepanel-tab-more">
                <div style="position:relative;">
                  <button id="sidepanelMoreBtn" aria-label="Show more tabs" style="background:none;border:none;padding:0 8px;cursor:pointer;font-size:1em;vertical-align:middle;">
                    <span style="font-size:1em;color:#fff;">&#8942;</span>
                  </button>
                  <div id="sidepanelMoreDropdown" style="display:none;position:absolute;top:32px;right:0;background:#222;color:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:120px;z-index:1003;">
                    <div class="sidepanel-more-item" data-tab-link="tab-1" style="padding:8px 16px;cursor:pointer;">About</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-2" style="padding:8px 16px;cursor:pointer;">Features</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-3" style="padding:8px 16px;cursor:pointer;">Wikipedia</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-4" style="padding:8px 16px;cursor:pointer;">Photos</div>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="sidepanel-content-wrapper">
            <div class="sidepanel-content">
              <div class="sidepanel-tab-content" data-tab-content="tab-1">
                <h4>About</h4>
                <p>Bengaluru Heritage Map<br>About content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-2" style="display:none;">
                <h4>Features</h4>
                <p>Features content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-3" style="display:none;">
                <h4>Wikipedia</h4>
                <p>Wikipedia content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-4" style="display:none;">
                <h4>Photos</h4>
                <p>Photos content here.</p>
              </div>
            </div>
          </div>
        </div>
  <!-- Removed internal toggle button (â˜°) -->
      </div>
      <!-- Query section (persistent, always below map) -->
      <div id="query-section"></div>
    </div>
  </div>
  <!-- Info Button to open modal -->
  <div style="position:absolute;top:10px;right:20px;z-index:1101;display:flex;gap:12px;align-items:center;">
  <a href="about.html" id="aboutBtn" class="btn btn-light" style="color:#2b2b2b; border:1px solid #ccc;">About</a>
    <button id="queryBtn" class="btn btn-outline-primary">
      <i class="bi bi-search"></i>
    </button>
  </div>


  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <!-- Leaflet.SidePanel plugin -->
  <script src="dist/leaflet-sidepanel.min.js"></script>

  <!-- Application JS -->
  <script src="js/navbar.js"></script>
  <script src="js/state.js"></script>
  <script src="js/dataLoader.js"></script>
  <script src="js/errorHandler.js"></script>
  <script src="js/popupFormatter.js"></script>
  <script src="js/map.js"></script>
  <script src="js/clustering.js"></script>
  <script src="js/mobileUI.js"></script>
  <script src="js/panelControl.js"></script>
  <script src="js/dropdown.js"></script>
  <script src="js/tooltip.js"></script>
  <script src="js/chart.js"></script>
  <script src="js/queryWidget.js"></script>
  <script>
    // Make populateFilterDropdownsFromGeojsons globally accessible
window.populateFilterDropdownsFromGeojsons = function() {
  var geojsons = [window.herostonesGeojson, window.inscriptionsGeojson, window.templesGeojson];
  var districtsSet = new Set();
  var taluksSet = new Set();
  geojsons.forEach(function(gj) {
    if (!gj || !gj.features) return;
    gj.features.forEach(function(f) {
      var props = f.properties || {};
      if (props.District_KGIS) districtsSet.add(props.District_KGIS);
      if (props.Taluk_KGIS) taluksSet.add(props.Taluk_KGIS);
    });
  });
  // Populate Districts dropdown
  var filterDistrictDropdownList = document.getElementById('filterDistrictDropdownList');
  var filterDistrictDropdownBtn = document.getElementById('filterDistrictDropdownBtn');
  if (filterDistrictDropdownList) {
    filterDistrictDropdownList.innerHTML = '';
    Array.from(districtsSet).sort().forEach(function(district) {
      var id = 'filterDistrictOpt_' + district.replace(/[^a-zA-Z0-9]/g, '');
      var div = document.createElement('div');
      div.className = 'dropdown-item';
      div.style.padding = '6px 12px';
      div.style.cursor = 'pointer';
      div.innerHTML = `<input type="checkbox" id="${id}" value="${district}" style="margin-right:8px;"> <label for="${id}">${district}</label>`;
      filterDistrictDropdownList.appendChild(div);
    });
  }
  // Populate Taluks dropdown
  var filterTalukDropdownList = document.getElementById('filterTalukDropdownList');
  if (filterTalukDropdownList) {
    filterTalukDropdownList.innerHTML = '';
    Array.from(taluksSet).sort().forEach(function(taluk) {
      var id = 'filterTalukOpt_' + taluk.replace(/[^a-zA-Z0-9]/g, '');
      var div = document.createElement('div');
      div.className = 'dropdown-item';
      div.style.padding = '6px 12px';
      div.style.cursor = 'pointer';
      // Style text in parentheses
      var label = taluk.replace(/\(([^)]+)\)/, '<span style="font-size:0.95em;color:#800000;">($1)</span>');
      div.innerHTML = `<input type="checkbox" id="${id}" value="${taluk}" style="margin-right:8px;"> <label for="${id}">${label}</label>`;
      filterTalukDropdownList.appendChild(div);
    });
  }
};

    // Initialize right info panel after map is created
    document.addEventListener('DOMContentLoaded', function() {
      // --- Filters Panel: Common Filters Dropdown Logic ---
      var filterDistrictDropdownBtn = document.getElementById('filterDistrictDropdownBtn');
      var filterDistrictDropdownList = document.getElementById('filterDistrictDropdownList');
      var filterTalukDropdownBtn = document.getElementById('filterTalukDropdownBtn');
      var filterTalukDropdownList = document.getElementById('filterTalukDropdownList');
      // Dropdown open/close logic
      if (filterDistrictDropdownBtn && filterDistrictDropdownList) {
        filterDistrictDropdownBtn.onclick = function(e) {
          e.stopPropagation();
          filterDistrictDropdownList.style.display = filterDistrictDropdownList.style.display === 'none' ? '' : 'none';
        };
        document.addEventListener('click', function() {
          filterDistrictDropdownList.style.display = 'none';
        });
        filterDistrictDropdownList.addEventListener('change', function() {
          var selected = Array.from(filterDistrictDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
          filterDistrictDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Districts';
          window._selectedFilterDistricts = selected;
          applyHeritageSitesFilter();
        });
      }
      if (filterTalukDropdownBtn && filterTalukDropdownList) {
        filterTalukDropdownBtn.onclick = function(e) {
          e.stopPropagation();
          filterTalukDropdownList.style.display = filterTalukDropdownList.style.display === 'none' ? '' : 'none';
        };
        document.addEventListener('click', function() {
          filterTalukDropdownList.style.display = 'none';
        });
        filterTalukDropdownList.addEventListener('change', function() {
          var selected = Array.from(filterTalukDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
          filterTalukDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Taluks';
          window._selectedFilterTaluks = selected;
          applyHeritageSitesFilter();
        });
      }
      // Load geojsons for dropdown population
      Promise.all([
        fetch('geojson/Herostones.geojson').then(r => r.json()),
        fetch('geojson/Inscriptions.geojson').then(r => r.json()),
        fetch('geojson/Temples.geojson').then(r => r.json())
      ]).then(function([herostones, inscriptions, temples]) {
        window.herostonesGeojson = herostones;
        window.inscriptionsGeojson = inscriptions;
        window.templesGeojson = temples;
        populateFilterDropdownsFromGeojsons();
      });
      // Populate Districts dropdown
      var districtSelect = document.getElementById('districtMultiSelect');
      if (districtSelect && window.districtGeojsonFiles) {
        districtSelect.innerHTML = '';
        window.districtGeojsonFiles.forEach(function(file) {
          var opt = document.createElement('option');
          opt.value = file;
          opt.textContent = file.replace('KA_', '').replace('.geojson', '').replace(/_/g, ' ');
          districtSelect.appendChild(opt);
        });
      }
      // Populate Taluks dropdown
      var talukSelect = document.getElementById('talukMultiSelect');
      if (talukSelect && window.talukGeojsonFiles) {
        talukSelect.innerHTML = '';
        window.talukGeojsonFiles.forEach(function(taluk) {
          var opt = document.createElement('option');
          opt.value = taluk.path;
          opt.textContent = taluk.label;
          talukSelect.appendChild(opt);
        });
      }
      // Districts selection logic
      if (districtSelect) {
        districtSelect.addEventListener('change', function() {
          var selected = Array.from(districtSelect.selectedOptions).map(function(opt) { return opt.value; });
          if (typeof setDistrictBoundariesVisibility === 'function') setDistrictBoundariesVisibility(selected);
        });
      }
      // Taluks selection logic
      if (talukSelect) {
        talukSelect.addEventListener('change', function() {
          var selected = Array.from(talukSelect.selectedOptions).map(function(opt) { return opt.value; });
          if (typeof setTalukBoundariesVisibility === 'function') setTalukBoundariesVisibility(selected);
        });
      }
      // --- Layer Panel Logic ---
      // Heritage Sites checkboxes
      var herostonesCheckbox = document.getElementById('layerHerostones');
      var inscriptionsCheckbox = document.getElementById('layerInscriptions');
      var templesCheckbox = document.getElementById('layerTemples');
      // Uncheck all by default for fast load
      if (herostonesCheckbox) herostonesCheckbox.checked = false;
      if (inscriptionsCheckbox) inscriptionsCheckbox.checked = false;
      if (templesCheckbox) templesCheckbox.checked = false;
      if (herostonesCheckbox) {
        herostonesCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Herostones', herostonesCheckbox.checked);
        });
      }
      if (inscriptionsCheckbox) {
        inscriptionsCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Inscriptions', inscriptionsCheckbox.checked);
        });
      }
      if (templesCheckbox) {
        templesCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Temples', templesCheckbox.checked);
        });
      }

      // Basemap radio buttons
      var basemapOSM = document.getElementById('basemapOSM');
      var basemapTerrain = document.getElementById('basemapTerrain');
      var basemapSatellite = document.getElementById('basemapSatellite');
      function setBasemap(name) {
        if (!window.map || !window.baseLayers) return;
        Object.keys(window.baseLayers).forEach(function(key) {
          window.map.removeLayer(window.baseLayers[key]);
        });
        if (window.baseLayers[name]) window.baseLayers[name].addTo(window.map);
      }
      if (basemapOSM) {
        basemapOSM.addEventListener('change', function() {
          if (basemapOSM.checked) setBasemap('OSM Standard');
        });
      }
      if (basemapTerrain) {
        basemapTerrain.addEventListener('change', function() {
          if (basemapTerrain.checked) setBasemap('OSM Terrain');
        });
      }
      if (basemapSatellite) {
        basemapSatellite.addEventListener('change', function() {
          if (basemapSatellite.checked) setBasemap('OSM Satellite');
        });
      }

      // Basemap opacity slider
      var basemapOpacity = document.getElementById('basemapOpacity');
      if (basemapOpacity) {
        basemapOpacity.addEventListener('input', function() {
          var val = parseFloat(basemapOpacity.value);
          // Find which basemap is active
          var activeBasemap = null;
          if (basemapOSM && basemapOSM.checked) activeBasemap = window.baseLayers['OSM Standard'];
          if (basemapTerrain && basemapTerrain.checked) activeBasemap = window.baseLayers['OSM Terrain'];
          if (basemapSatellite && basemapSatellite.checked) activeBasemap = window.baseLayers['OSM Satellite'];
          if (activeBasemap && typeof activeBasemap.setOpacity === 'function') {
            activeBasemap.setOpacity(val);
          }
        });
      }
      // Left panel tab switching logic
      const leftTabLinks = document.querySelectorAll('#panelLeft .sidebar-tab-link');
      const leftTabContents = document.querySelectorAll('#panelLeft .sidepanel-tab-content');
      leftTabLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tabId = link.getAttribute('data-tab-link');
          leftTabContents.forEach(function(content) {
            content.style.display = content.getAttribute('data-tab-content') === tabId ? '' : 'none';
          });
        });
      });
      // Left panel toggle logic now handled by panelControl.js
      if (window.map) {
        const panelRight = L.control.sidepanel('panelRight', {
          panelPosition: 'right',
          hasTabs: true,
          tabsPosition: 'top',
          pushControls: true,
          darkMode: true,
          startTab: 'tab-1'
        }).addTo(window.map);
        // Apply dark mode styles
        var panel = document.getElementById('panelRight');
        panel.classList.add('sidepanel-dark');
        // Panel expansion now handled by panelControl.js
        /*
        // Force expanded state after plugin initializes
        panel.style.right = '0px';
        var arrow = document.getElementById('panelRightArrow');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
        */
        // Tab switching logic
        const tabLinks = document.querySelectorAll('#panelRight .sidebar-tab-link');
        const tabContents = document.querySelectorAll('#panelRight .sidepanel-tab-content');
        tabLinks.forEach(function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab-link');
            tabContents.forEach(function(content) {
              content.style.display = content.getAttribute('data-tab-content') === tabId ? '' : 'none';
            });
          });
        });
        // More button logic to show hidden tabs
        const moreBtn = document.getElementById('sidepanelMoreBtn');
        const moreDropdown = document.getElementById('sidepanelMoreDropdown');
        if (moreBtn && moreDropdown) {
          moreBtn.onclick = function(e) {
            e.stopPropagation();
            moreDropdown.style.display = moreDropdown.style.display === 'none' ? '' : 'none';
          };
          // Hide dropdown when clicking outside
          document.addEventListener('click', function() {
            moreDropdown.style.display = 'none';
          });
          moreDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            const tabId = e.target.getAttribute('data-tab-link');
            if (tabId) {
              // Switch to selected tab
              const tabLinks = document.querySelectorAll('#panelRight .sidebar-tab-link');
              const tabContents = document.querySelectorAll('#panelRight .sidepanel-tab-content');
              tabLinks.forEach(function(link) {
                if (link.getAttribute('data-tab-link') === tabId) {
                  link.click();
                }
              });
              moreDropdown.style.display = 'none';
            }
          });
        }
        // Toggle button logic now handled by panelControl.js
        // Info button opens About tab and shows panel
        const infoBtn = document.getElementById('infoBtn');
        if (infoBtn) {
          infoBtn.onclick = function() {
            document.getElementById('panelRight').setAttribute('aria-hidden', 'false');
            tabContents.forEach(function(content) {
              content.style.display = content.getAttribute('data-tab-content') === 'tab-1' ? '' : 'none';
            });
          };
        }
      }
    });
    // Filter logic for Heritage Sites layer
window.applyHeritageSitesFilter = function() {
  // Only filter visible layers
  ['Herostones', 'Inscriptions', 'Temples'].forEach(function(layerName) {
    var visible = false;
    var checkbox = document.getElementById('layer' + layerName);
    if (checkbox) visible = checkbox.checked;
    if (!visible) return;
    var layerObj = null;
    if (layerName === 'Herostones') layerObj = window.herostonesLayer;
    if (layerName === 'Inscriptions') layerObj = window.inscriptionsLayer;
    if (layerName === 'Temples') layerObj = window.templesLayer;
    if (!layerObj) return;
    // Remove all features first
    layerObj.clearLayers();
    // Use loaded geojson for filtering
    var geojsonData = null;
    if (layerName === 'Herostones') geojsonData = window.herostonesGeojson;
    if (layerName === 'Inscriptions') geojsonData = window.inscriptionsGeojson;
    if (layerName === 'Temples') geojsonData = window.templesGeojson;
    if (!geojsonData || !geojsonData.features) return;
    var filtered = geojsonData.features.filter(function(f) {
      var props = f.properties || {};
      var matchDistrict = !window._selectedFilterDistricts || window._selectedFilterDistricts.length === 0 || window._selectedFilterDistricts.includes(props.District_KGIS);
      var matchTaluk = !window._selectedFilterTaluks || window._selectedFilterTaluks.length === 0 || window._selectedFilterTaluks.includes(props.Taluk_KGIS);
      return matchDistrict && matchTaluk;
    });
    layerObj.addData({type:'FeatureCollection',features:filtered});
  });
};
    // Improved responsive resize for query-section to handle right panel overlap
// This function is now called by panelControl.js when panel states change
function resizeQuerySection() {
  var leftPanel = document.getElementById('panelLeft');
  var rightPanel = document.getElementById('panelRight');
  var querySection = document.getElementById('query-section');
  var leftWidth = (leftPanel && (leftPanel.style.left === '0px' || leftPanel.style.left === '')) ? 320 : 0;
  var rightWidth = (rightPanel && (rightPanel.style.right === '0px' || rightPanel.style.right === '')) ? 320 : 0;
  if (querySection) {
    querySection.style.marginLeft = leftWidth + 'px';
    querySection.style.marginRight = rightWidth + 'px';
    // Also set width to avoid overlap
    var container = document.getElementById('mainContent');
    if (container) {
      var totalWidth = container.offsetWidth;
      querySection.style.width = (totalWidth - leftWidth - rightWidth) + 'px';
    }
  }
}

// --- Custom Dropdown Logic for Districts (Layer Panel) ---
var districtDropdownBtn = document.getElementById('districtDropdownBtn');
var districtDropdownList = document.getElementById('districtDropdownList');
if (districtDropdownBtn && districtDropdownList && window.districtGeojsonFiles) {
  districtDropdownBtn.onclick = function(e) {
    e.stopPropagation();
    districtDropdownList.style.display = districtDropdownList.style.display === 'none' ? '' : 'none';
  };
  document.addEventListener('click', function() {
    districtDropdownList.style.display = 'none';
  });
  districtDropdownList.innerHTML = '';
  window.districtGeojsonFiles.forEach(function(file) {
    var id = 'districtOpt_' + file.replace(/[^a-zA-Z0-9]/g, '');
    var div = document.createElement('div');
    div.className = 'dropdown-item';
    div.style.padding = '6px 12px';
    div.style.cursor = 'pointer';
    div.innerHTML = `<input type="checkbox" id="${id}" value="${file}" style="margin-right:8px;"> <label for="${id}">${file.replace('KA_', '').replace('.geojson', '').replace(/_/g, ' ')}</label>`;
    districtDropdownList.appendChild(div);
  });
  // Selection logic
  districtDropdownList.addEventListener('change', function() {
    var selected = Array.from(districtDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
    if (typeof setDistrictBoundariesVisibility === 'function') setDistrictBoundariesVisibility(selected);
    districtDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Districts';
  });
}
// --- Custom Dropdown Logic for Taluks (Layer Panel) ---
var talukDropdownBtn = document.getElementById('talukDropdownBtn');
var talukDropdownList = document.getElementById('talukDropdownList');
if (talukDropdownBtn && talukDropdownList && window.talukGeojsonFiles) {
  talukDropdownBtn.onclick = function(e) {
    e.stopPropagation();
    talukDropdownList.style.display = talukDropdownList.style.display === 'none' ? '' : 'none';
  };
  document.addEventListener('click', function() {
    talukDropdownList.style.display = 'none';
  });
  talukDropdownList.innerHTML = '';
  window.talukGeojsonFiles.forEach(function(taluk) {
    var id = 'talukOpt_' + taluk.path.replace(/[^a-zA-Z0-9]/g, '');
    var div = document.createElement('div');
    div.className = 'dropdown-item';
    div.style.padding = '6px 12px';
    div.style.cursor = 'pointer';
    // Style text in parentheses
    var label = taluk.label.replace(/\(([^)]+)\)/, '<span style="font-size:0.95em;color:#800000;">($1)</span>');
    div.innerHTML = `<input type="checkbox" id="${id}" value="${taluk.path}" style="margin-right:8px;"> <label for="${id}">${label}</label>`;
    talukDropdownList.appendChild(div);
  });
  // Selection logic
  talukDropdownList.addEventListener('change', function() {
    var selected = Array.from(talukDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
    if (typeof setTalukBoundariesVisibility === 'function') setTalukBoundariesVisibility(selected);
    talukDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Taluks';
  });
}

// --- Cluster toggle logic for Heritage Sites layers (only when layer is visible, else notify) ---
function isLayerVisible(layerName) {
  var checkbox = document.getElementById('layer' + layerName);
  return checkbox && checkbox.checked;
}
function showLayerNotification(layerName) {
  if (window.L && L.Notification) {
    new L.Notification({
      message: layerName + ' layer must be visible to enable clustering.',
      type: 'warning',
      position: 'topright',
      timeout: 2500
    }).show();
  } else {
    alert(layerName + ' layer must be visible to enable clustering.');
  }
}
if (clusterHerostones) {
  clusterHerostones.addEventListener('change', function(e) {
    if (isLayerVisible('Herostones') && typeof setLayerClustering === 'function') {
      setLayerClustering('Herostones', clusterHerostones.checked);
    } else {
      e.preventDefault();
      clusterHerostones.checked = !clusterHerostones.checked;
      showLayerNotification('Herostones');
    }
  });
}
if (clusterInscriptions) {
  clusterInscriptions.addEventListener('change', function(e) {
    if (isLayerVisible('Inscriptions') && typeof setLayerClustering === 'function') {
      setLayerClustering('Inscriptions', clusterInscriptions.checked);
    } else {
      e.preventDefault();
      clusterInscriptions.checked = !clusterInscriptions.checked;
      showLayerNotification('Inscriptions');
    }
  });
}
if (clusterTemples) {
  clusterTemples.addEventListener('change', function(e) {
    if (isLayerVisible('Temples') && typeof setLayerClustering === 'function') {
      setLayerClustering('Temples', clusterTemples.checked);
    } else {
      e.preventDefault();
      clusterTemples.checked = !clusterTemples.checked;
      showLayerNotification('Temples');
    }
  });
}

// --- Period (Century) noUiSlider initialization and filter logic ---
function getPeriodRangeFromGeojsons() {
  var geojsons = [window.herostonesGeojson, window.inscriptionsGeojson, window.templesGeojson];
  var periods = [];
  geojsons.forEach(function(gj) {
    if (!gj || !gj.features) return;
    gj.features.forEach(function(f) {
      var p = f.properties && f.properties['Period (Century)'];
      if (p !== undefined && p !== null && !isNaN(Number(p))) periods.push(Number(p));
    });
  });
  if (periods.length === 0) return [0, 100];
  return [Math.min.apply(null, periods), Math.max.apply(null, periods)];
}

function initPeriodSliders() {
  var range = getPeriodRangeFromGeojsons();
  var minSlider = document.getElementById('periodMinSlider');
  var maxSlider = document.getElementById('periodMaxSlider');
  var minValueDiv = document.getElementById('periodMinSliderValue');
  var maxValueDiv = document.getElementById('periodMaxSliderValue');
  if (!minSlider || !maxSlider) return;

  // Set min/max attributes based on data
  minSlider.min = range[0];
  minSlider.max = range[1];
  maxSlider.min = range[0];
  maxSlider.max = range[1];

  // Initial values
  minSlider.value = range[0];
  maxSlider.value = range[1];

  function updatePeriodRange() {
    var minVal = parseInt(minSlider.value);
    var maxVal = parseInt(maxSlider.value);
    if (minVal > maxVal) {
      maxVal = minVal;
      maxSlider.value = minVal;
    }
    window._selectedPeriodRange = [minVal, maxVal];
    minValueDiv.textContent = minVal;
    maxValueDiv.textContent = maxVal;
    applyHeritageSitesFilter();
    if (typeof window.renderFeaturesDropdowns === 'function') window.renderFeaturesDropdowns();
  }

  minSlider.addEventListener('input', updatePeriodRange);
  maxSlider.addEventListener('input', updatePeriodRange);

  // Set initial value
  window._selectedPeriodRange = [range[0], range[1]];
  minValueDiv.textContent = range[0];
  maxValueDiv.textContent = range[1];
}

// Extend applyHeritageSitesFilter to filter by period
var _origApplyHeritageSitesFilter = window.applyHeritageSitesFilter;
window.applyHeritageSitesFilter = function() {
  var periodRange = window._selectedPeriodRange || getPeriodRangeFromGeojsons();
  ['Herostones', 'Inscriptions', 'Temples'].forEach(function(layerName) {
    var visible = false;
    var checkbox = document.getElementById('layer' + layerName);
    if (checkbox) visible = checkbox.checked;
    if (!visible) return;
    var layerObj = null;
    if (layerName === 'Herostones') layerObj = window.herostonesLayer;
    if (layerName === 'Inscriptions') layerObj = window.inscriptionsLayer;
    if (layerName === 'Temples') layerObj = window.templesLayer;
    if (!layerObj) return;
    layerObj.clearLayers();
    var geojsonData = null;
    if (layerName === 'Herostones') geojsonData = window.herostonesGeojson;
    if (layerName === 'Inscriptions') geojsonData = window.inscriptionsGeojson;
    if (layerName === 'Temples') geojsonData = window.templesGeojson;
    if (!geojsonData || !geojsonData.features) return;
    var filtered = geojsonData.features.filter(function(f) {
      var props = f.properties || {};
      var matchDistrict = !window._selectedFilterDistricts || window._selectedFilterDistricts.length === 0 || window._selectedFilterDistricts.includes(props.District_KGIS);
      var matchTaluk = !window._selectedFilterTaluks || window._selectedFilterTaluks.length === 0 || window._selectedFilterTaluks.includes(props.Taluk_KGIS);
      var matchPeriod = !periodRange || (props['Period (Century)'] !== undefined && props['Period (Century)'] !== null && !isNaN(Number(props['Period (Century)'])) && Number(props['Period (Century)']) >= periodRange[0] && Number(props['Period (Century)']) <= periodRange[1]);
      return matchDistrict && matchTaluk && matchPeriod;
    });
    layerObj.addData({type:'FeatureCollection',features:filtered});
  });
};

    // Initialize slider after geojsons are loaded
    Promise.all([
      fetch('geojson/Herostones.geojson').then(r => r.json()),
      fetch('geojson/Inscriptions.geojson').then(r => r.json()),
      fetch('geojson/Temples.geojson').then(r => r.json())
    ]).then(function([herostones, inscriptions, temples]) {
      window.herostonesGeojson = herostones;
      window.inscriptionsGeojson = inscriptions;
      window.templesGeojson = temples;
      populateFilterDropdownsFromGeojsons();
  initPeriodSliders();
    });
  </script>
</body>
</html>
