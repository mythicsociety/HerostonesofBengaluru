<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bengaluru Heritage Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/marker-blink.css"/>
  <!-- Leaflet.SidePanel plugin -->
  <link rel="stylesheet" href="dist/leaflet-sidepanel.css"/>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light" style="z-index:1100;">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Bengaluru Heritage Map</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <!-- Navigation links removed -->
      </div>
    </div>
  </nav>

  <!-- Flex container for sidebar and main content -->
  <div id="appContainer">
  <!-- Left Sidebar removed -->
    <!-- Main content area: map and query section stacked vertically -->
    <div id="mainContent">
      <!-- Left SidePanel container for Leaflet.SidePanel plugin -->
      <div id="panelLeft" class="sidepanel" aria-label="left side panel" aria-hidden="true" style="left:-320px; top:56px; height:calc(100vh - 56px); position:absolute; z-index:1001;">
        <!-- Vertical toggle button on right edge of left panel -->
        <button id="panelLeftToggle" aria-label="Toggle left panel" style="position:absolute;right:-32px;top:50%;transform:translateY(-50%);width:32px;height:48px;background:#2b2b2b;border-radius:0 5px 5px 0;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center;z-index:1002;cursor:pointer;transition:background 0.2s;">
          <span id="panelLeftArrow" style="display:inline-block;transition:transform 0.2s;font-size:1.5em;color:#fff;">&#x2A1E;</span>
        </button>
        <div class="sidepanel-inner-wrapper">
          <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
            <ul class="sidepanel-tabs">
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-layers">
                  <i class="bi bi-layers" style="font-size:1.5em;"></i>
                </a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-filters">
                  <i class="bi bi-funnel" style="font-size:1.5em;"></i>
                </a>
              </li>
            </ul>
          </nav>
          <div class="sidepanel-content-wrapper">
            <div class="sidepanel-content">
              <div class="sidepanel-tab-content" data-tab-content="tab-layers">
                <h4>Layers</h4>
                <div id="sidepanel-layers">
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Heritage Sites</h5>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerHerostones" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerHerostones">Herostones</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterHerostones">
                        <label class="form-check-label" for="clusterHerostones" title="Cluster markers">Cluster</label>
                      </div>
                    </div>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerInscriptions" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerInscriptions">Inscriptions</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterInscriptions">
                        <label class="form-check-label" for="clusterInscriptions" title="Cluster markers">Cluster</label>
                      </div>
                    </div>
                    <div class="form-check d-flex align-items-center mb-2">
                      <input class="form-check-input" type="checkbox" id="layerTemples" checked>
                      <label class="form-check-label flex-grow-1 ms-2" for="layerTemples">Temples</label>
                      <div class="form-switch ms-2">
                        <input class="form-check-input" type="checkbox" id="clusterTemples">
                        <label class="form-check-label" for="clusterTemples" title="Cluster markers">Cluster</label>
                      </div>
                    </div>
                  </div>
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Basemaps</h5>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapOSM" checked>
                      <label class="form-check-label" for="basemapOSM">OSM Standard</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapTerrain">
                      <label class="form-check-label" for="basemapTerrain">Terrain</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="basemap" id="basemapSatellite">
                      <label class="form-check-label" for="basemapSatellite">Satellite</label>
                    </div>
                    <div style="margin-top:10px;">
                      <label for="basemapOpacity" style="font-size:0.95em;">Opacity</label>
                      <input type="range" id="basemapOpacity" min="0.2" max="1" step="0.01" value="1" style="width:100%;">
                    </div>
                  </div>
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Administration Boundaries</h5>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Districts</label>
                      <div id="districtDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="districtDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Districts</button>
                        <div id="districtDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;">
                          <!-- District options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Taluks</label>
                      <div id="talukDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="talukDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Taluks</button>
                        <div id="talukDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;max-height:none;">
                          <!-- Taluk options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-filters" style="display:none;">
                <h4>Filters</h4>
                <div id="sidepanel-filters">
                  <div style="margin-bottom:18px;">
                    <h5 style="font-size:1.1em; font-weight:600;">Common Filters</h5>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Districts (District_KGIS)</label>
                      <div id="filterDistrictDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="filterDistrictDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Districts</button>
                        <div id="filterDistrictDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;">
                          <!-- District options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label style="font-size:0.98em;font-weight:500;">Taluks (Taluk_KGIS)</label>
                      <div id="filterTalukDropdown" class="custom-dropdown" style="position:relative;">
                        <button type="button" id="filterTalukDropdownBtn" class="btn btn-outline-secondary w-100" style="text-align:left;">Select Taluks</button>
                        <div id="filterTalukDropdownList" class="custom-dropdown-list" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:10;max-height:60vh;overflow-y:auto;">
                          <!-- Taluk options will be injected by JS -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Map container -->
      <div id="map"></div>
      <!-- Right Info SidePanel -->
  <div id="panelRight" class="sidepanel" aria-label="side panel" aria-hidden="true" style="right:-320px; top:56px; height:calc(100vh - 56px);">
  <!-- Vertical toggle button on left edge -->
        <button id="panelRightToggle" aria-label="Toggle right panel" style="position:absolute;left: -32px ;top:50%;transform:translateY(-50%);width:32px;height:48px;background:#2b2b2b;border-radius: 5px 0 0 5px;border:1px solid #ccc;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center;z-index:1002;cursor:pointer;transition:background 0.2s;">
          <span id="panelRightArrow" style="display:inline-block;transition:transform 0.2s;font-size:1.5em;">
            <span style="color:#fff;">&#x2A1E;</span>
          </span>
        </button>
        <div class="sidepanel-inner-wrapper">
          <nav class="sidepanel-tabs-wrapper" aria-label="sidepanel tab navigation">
            <ul class="sidepanel-tabs">
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-1">About</a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-2">Features</a>
              </li>
              <li class="sidepanel-tab">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-3">Wikipedia</a>
              </li>
              <li class="sidepanel-tab sidepanel-tab-hidden" style="display:none;">
                <a href="#" class="sidebar-tab-link" role="tab" data-tab-link="tab-4">Photos</a>
              </li>
              <li class="sidepanel-tab sidepanel-tab-more">
                <div style="position:relative;">
                  <button id="sidepanelMoreBtn" aria-label="Show more tabs" style="background:none;border:none;padding:0 8px;cursor:pointer;font-size:1em;vertical-align:middle;">
                    <span style="font-size:1em;color:#fff;">&#8942;</span>
                  </button>
                  <div id="sidepanelMoreDropdown" style="display:none;position:absolute;top:32px;right:0;background:#222;color:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15);min-width:120px;z-index:1003;">
                    <div class="sidepanel-more-item" data-tab-link="tab-1" style="padding:8px 16px;cursor:pointer;">About</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-2" style="padding:8px 16px;cursor:pointer;">Features</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-3" style="padding:8px 16px;cursor:pointer;">Wikipedia</div>
                    <div class="sidepanel-more-item" data-tab-link="tab-4" style="padding:8px 16px;cursor:pointer;">Photos</div>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="sidepanel-content-wrapper">
            <div class="sidepanel-content">
              <div class="sidepanel-tab-content" data-tab-content="tab-1">
                <h4>About</h4>
                <p>Bengaluru Heritage Map<br>About content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-2" style="display:none;">
                <h4>Features</h4>
                <p>Features content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-3" style="display:none;">
                <h4>Wikipedia</h4>
                <p>Wikipedia content here.</p>
              </div>
              <div class="sidepanel-tab-content" data-tab-content="tab-4" style="display:none;">
                <h4>Photos</h4>
                <p>Photos content here.</p>
              </div>
            </div>
          </div>
        </div>
  <!-- Removed internal toggle button (â˜°) -->
      </div>
      <!-- Query section (persistent, always below map) -->
      <div id="query-section"></div>
    </div>
  </div>
  <!-- Info Button to open modal -->
  <div style="position:absolute;top:10px;right:20px;z-index:1101;display:flex;gap:12px;align-items:center;">
    <button id="queryBtn" class="btn btn-outline-primary">
      <i class="bi bi-search"></i>
    </button>
  </div>


  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet.SidePanel plugin -->
  <script src="dist/leaflet-sidepanel.min.js"></script>

  <!-- Application JS -->
  <script src="js/navbar.js"></script>
  <script src="js/state.js"></script>
  <script src="js/dataLoader.js"></script>
  <script src="js/map.js"></script>
  <!-- <script src="js/layers.js"></script> -->
  <!-- <script src="js/spatialFilter.js"></script> -->
  <!-- <script src="js/sidebarLeft.js"></script> -->
  <script src="js/tooltip.js"></script>
  <script src="js/chart.js"></script>
  <script src="js/queryWidget.js"></script>
  <script src="js/SidePanel.js"></script>
  <script>
    // Initialize right info panel after map is created
    document.addEventListener('DOMContentLoaded', function() {
      // --- Filters Panel: Common Filters Dropdown Logic ---
      var filterDistrictDropdownBtn = document.getElementById('filterDistrictDropdownBtn');
      var filterDistrictDropdownList = document.getElementById('filterDistrictDropdownList');
      var filterTalukDropdownBtn = document.getElementById('filterTalukDropdownBtn');
      var filterTalukDropdownList = document.getElementById('filterTalukDropdownList');
      function populateFilterDropdownsFromGeojsons() {
        var geojsons = [window.herostonesGeojson, window.inscriptionsGeojson, window.templesGeojson];
        var districtsSet = new Set();
        var taluksSet = new Set();
        geojsons.forEach(function(gj) {
          if (!gj || !gj.features) return;
          gj.features.forEach(function(f) {
            var props = f.properties || {};
            if (props.District_KGIS) districtsSet.add(props.District_KGIS);
            if (props.Taluk_KGIS) taluksSet.add(props.Taluk_KGIS);
          });
        });
        // Populate Districts dropdown
        filterDistrictDropdownList.innerHTML = '';
        Array.from(districtsSet).sort().forEach(function(district) {
          var id = 'filterDistrictOpt_' + district.replace(/[^a-zA-Z0-9]/g, '');
          var div = document.createElement('div');
          div.className = 'dropdown-item';
          div.style.padding = '6px 12px';
          div.style.cursor = 'pointer';
          div.innerHTML = `<input type="checkbox" id="${id}" value="${district}" style="margin-right:8px;"> <label for="${id}">${district}</label>`;
          filterDistrictDropdownList.appendChild(div);
        });
        // Populate Taluks dropdown
        filterTalukDropdownList.innerHTML = '';
        Array.from(taluksSet).sort().forEach(function(taluk) {
          var id = 'filterTalukOpt_' + taluk.replace(/[^a-zA-Z0-9]/g, '');
          var div = document.createElement('div');
          div.className = 'dropdown-item';
          div.style.padding = '6px 12px';
          div.style.cursor = 'pointer';
          // Style text in parentheses
          var label = taluk.replace(/\(([^)]+)\)/, '<span style="font-size:0.95em;color:#800000;">($1)</span>');
          div.innerHTML = `<input type="checkbox" id="${id}" value="${taluk}" style="margin-right:8px;"> <label for="${id}">${label}</label>`;
          filterTalukDropdownList.appendChild(div);
        });
      }
      // Dropdown open/close logic
      if (filterDistrictDropdownBtn && filterDistrictDropdownList) {
        filterDistrictDropdownBtn.onclick = function(e) {
          e.stopPropagation();
          filterDistrictDropdownList.style.display = filterDistrictDropdownList.style.display === 'none' ? '' : 'none';
        };
        document.addEventListener('click', function() {
          filterDistrictDropdownList.style.display = 'none';
        });
        filterDistrictDropdownList.addEventListener('change', function() {
          var selected = Array.from(filterDistrictDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
          filterDistrictDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Districts';
          window._selectedFilterDistricts = selected;
          applyHeritageSitesFilter();
        });
      }
      if (filterTalukDropdownBtn && filterTalukDropdownList) {
        filterTalukDropdownBtn.onclick = function(e) {
          e.stopPropagation();
          filterTalukDropdownList.style.display = filterTalukDropdownList.style.display === 'none' ? '' : 'none';
        };
        document.addEventListener('click', function() {
          filterTalukDropdownList.style.display = 'none';
        });
        filterTalukDropdownList.addEventListener('change', function() {
          var selected = Array.from(filterTalukDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(function(cb) { return cb.value; });
          filterTalukDropdownBtn.textContent = selected.length ? selected.join(', ') : 'Select Taluks';
          window._selectedFilterTaluks = selected;
          applyHeritageSitesFilter();
        });
      }
      // Load geojsons for dropdown population
      Promise.all([
        fetch('geojson/Herostones.geojson').then(r => r.json()),
        fetch('geojson/Inscriptions.geojson').then(r => r.json()),
        fetch('geojson/Temples.geojson').then(r => r.json())
      ]).then(function([herostones, inscriptions, temples]) {
        window.herostonesGeojson = herostones;
        window.inscriptionsGeojson = inscriptions;
        window.templesGeojson = temples;
        populateFilterDropdownsFromGeojsons();
      });
      // Populate Districts dropdown
      var districtSelect = document.getElementById('districtMultiSelect');
      if (districtSelect && window.districtGeojsonFiles) {
        districtSelect.innerHTML = '';
        window.districtGeojsonFiles.forEach(function(file) {
          var opt = document.createElement('option');
          opt.value = file;
          opt.textContent = file.replace('KA_', '').replace('.geojson', '').replace(/_/g, ' ');
          districtSelect.appendChild(opt);
        });
      }
      // Populate Taluks dropdown
      var talukSelect = document.getElementById('talukMultiSelect');
      if (talukSelect && window.talukGeojsonFiles) {
        talukSelect.innerHTML = '';
        window.talukGeojsonFiles.forEach(function(taluk) {
          var opt = document.createElement('option');
          opt.value = taluk.path;
          opt.textContent = taluk.label;
          talukSelect.appendChild(opt);
        });
      }
      // Districts selection logic
      if (districtSelect) {
        districtSelect.addEventListener('change', function() {
          var selected = Array.from(districtSelect.selectedOptions).map(function(opt) { return opt.value; });
          if (typeof setDistrictBoundariesVisibility === 'function') setDistrictBoundariesVisibility(selected);
        });
      }
      // Taluks selection logic
      if (talukSelect) {
        talukSelect.addEventListener('change', function() {
          var selected = Array.from(talukSelect.selectedOptions).map(function(opt) { return opt.value; });
          if (typeof setTalukBoundariesVisibility === 'function') setTalukBoundariesVisibility(selected);
        });
      }
      // --- Layer Panel Logic ---
      // Heritage Sites checkboxes
      var herostonesCheckbox = document.getElementById('layerHerostones');
      var inscriptionsCheckbox = document.getElementById('layerInscriptions');
      var templesCheckbox = document.getElementById('layerTemples');
      // Uncheck all by default for fast load
      if (herostonesCheckbox) herostonesCheckbox.checked = false;
      if (inscriptionsCheckbox) inscriptionsCheckbox.checked = false;
      if (templesCheckbox) templesCheckbox.checked = false;
      if (herostonesCheckbox) {
        herostonesCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Herostones', herostonesCheckbox.checked);
        });
      }
      if (inscriptionsCheckbox) {
        inscriptionsCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Inscriptions', inscriptionsCheckbox.checked);
        });
      }
      if (templesCheckbox) {
        templesCheckbox.addEventListener('change', function() {
          if (typeof setLayerVisibility === 'function') setLayerVisibility('Temples', templesCheckbox.checked);
        });
      }

      // Basemap radio buttons
      var basemapOSM = document.getElementById('basemapOSM');
      var basemapTerrain = document.getElementById('basemapTerrain');
      var basemapSatellite = document.getElementById('basemapSatellite');
      function setBasemap(name) {
        if (!window.map || !window.baseLayers) return;
        Object.keys(window.baseLayers).forEach(function(key) {
          window.map.removeLayer(window.baseLayers[key]);
        });
        if (window.baseLayers[name]) window.baseLayers[name].addTo(window.map);
      }
      if (basemapOSM) {
        basemapOSM.addEventListener('change', function() {
          if (basemapOSM.checked) setBasemap('OSM Standard');
        });
      }
      if (basemapTerrain) {
        basemapTerrain.addEventListener('change', function() {
          if (basemapTerrain.checked) setBasemap('OSM Terrain');
        });
      }
      if (basemapSatellite) {
        basemapSatellite.addEventListener('change', function() {
          if (basemapSatellite.checked) setBasemap('OSM Satellite');
        });
      }

      // Basemap opacity slider
      var basemapOpacity = document.getElementById('basemapOpacity');
      if (basemapOpacity) {
        basemapOpacity.addEventListener('input', function() {
          var val = parseFloat(basemapOpacity.value);
          // Find which basemap is active
          var activeBasemap = null;
          if (basemapOSM && basemapOSM.checked) activeBasemap = window.baseLayers['OSM Standard'];
          if (basemapTerrain && basemapTerrain.checked) activeBasemap = window.baseLayers['OSM Terrain'];
          if (basemapSatellite && basemapSatellite.checked) activeBasemap = window.baseLayers['OSM Satellite'];
          if (activeBasemap && typeof activeBasemap.setOpacity === 'function') {
            activeBasemap.setOpacity(val);
          }
        });
      }
      // Left panel tab switching logic
      const leftTabLinks = document.querySelectorAll('#panelLeft .sidebar-tab-link');
      const leftTabContents = document.querySelectorAll('#panelLeft .sidepanel-tab-content');
      leftTabLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tabId = link.getAttribute('data-tab-link');
          leftTabContents.forEach(function(content) {
            content.style.display = content.getAttribute('data-tab-content') === tabId ? '' : 'none';
          });
        });
      });
      // Left panel toggle logic
      const leftPanel = document.getElementById('panelLeft');
      const leftToggle = document.getElementById('panelLeftToggle');
      const leftArrow = document.getElementById('panelLeftArrow');
      if (leftPanel && leftToggle) {
        leftToggle.onclick = function() {
          if (leftPanel.style.left === '0px' || leftPanel.style.left === '') {
            leftPanel.style.left = '-320px';
            leftArrow.style.transform = 'rotate(180deg)';
          } else {
            leftPanel.style.left = '0px';
            leftArrow.style.transform = 'rotate(0deg)';
          }
        };
        // Start collapsed
        leftPanel.style.left = '-320px';
        leftArrow.style.transform = 'rotate(180deg)';
      }
      if (window.map) {
        const panelRight = L.control.sidepanel('panelRight', {
          panelPosition: 'right',
          hasTabs: true,
          tabsPosition: 'top',
          pushControls: true,
          darkMode: true,
          startTab: 'tab-1'
        }).addTo(window.map);
        // Apply dark mode styles
        var panel = document.getElementById('panelRight');
        panel.classList.add('sidepanel-dark');
        // Force collapsed state after plugin initializes
        panel.style.right = '-320px';
        var arrow = document.getElementById('panelRightArrow');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
        // Tab switching logic
        const tabLinks = document.querySelectorAll('#panelRight .sidebar-tab-link');
        const tabContents = document.querySelectorAll('#panelRight .sidepanel-tab-content');
        tabLinks.forEach(function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const tabId = link.getAttribute('data-tab-link');
            tabContents.forEach(function(content) {
              content.style.display = content.getAttribute('data-tab-content') === tabId ? '' : 'none';
            });
          });
        });
        // More button logic to show hidden tabs
        const moreBtn = document.getElementById('sidepanelMoreBtn');
        const moreDropdown = document.getElementById('sidepanelMoreDropdown');
        if (moreBtn && moreDropdown) {
          moreBtn.onclick = function(e) {
            e.stopPropagation();
            moreDropdown.style.display = moreDropdown.style.display === 'none' ? '' : 'none';
          };
          // Hide dropdown when clicking outside
          document.addEventListener('click', function() {
            moreDropdown.style.display = 'none';
          });
          moreDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
            const tabId = e.target.getAttribute('data-tab-link');
            if (tabId) {
              // Switch to selected tab
              const tabLinks = document.querySelectorAll('#panelRight .sidebar-tab-link');
              const tabContents = document.querySelectorAll('#panelRight .sidepanel-tab-content');
              tabLinks.forEach(function(link) {
                if (link.getAttribute('data-tab-link') === tabId) {
                  link.click();
                }
              });
              moreDropdown.style.display = 'none';
            }
          });
        }
        // Toggle button logic
        const leftEdgeToggle = document.getElementById('panelRightToggle');
        if (leftEdgeToggle) {
          leftEdgeToggle.onclick = function() {
            const panel = document.getElementById('panelRight');
            const arrow = document.getElementById('panelRightArrow');
            if (panel.style.right === '0px' || panel.style.right === '') {
              panel.style.right = '-320px';
              arrow.style.transform = 'rotate(180deg)';
            } else {
              panel.style.right = '0px';
              arrow.style.transform = 'rotate(0deg)';
            }
          };
        }
        // Info button opens About tab and shows panel
        const infoBtn = document.getElementById('infoBtn');
        if (infoBtn) {
          infoBtn.onclick = function() {
            document.getElementById('panelRight').setAttribute('aria-hidden', 'false');
            tabContents.forEach(function(content) {
              content.style.display = content.getAttribute('data-tab-content') === 'tab-1' ? '' : 'none';
            });
          };
        }
      }
    });
    // Filter logic for Heritage Sites layer
window.applyHeritageSitesFilter = function() {
  // Only filter visible layers
  ['Herostones', 'Inscriptions', 'Temples'].forEach(function(layerName) {
    var visible = false;
    var checkbox = document.getElementById('layer' + layerName);
    if (checkbox) visible = checkbox.checked;
    if (!visible) return;
    var layerObj = null;
    if (layerName === 'Herostones') layerObj = window.herostonesLayer;
    if (layerName === 'Inscriptions') layerObj = window.inscriptionsLayer;
    if (layerName === 'Temples') layerObj = window.templesLayer;
    if (!layerObj) return;
    // Remove all features first
    layerObj.clearLayers();
    // Use loaded geojson for filtering
    var geojsonData = null;
    if (layerName === 'Herostones') geojsonData = window.herostonesGeojson;
    if (layerName === 'Inscriptions') geojsonData = window.inscriptionsGeojson;
    if (layerName === 'Temples') geojsonData = window.templesGeojson;
    if (!geojsonData || !geojsonData.features) return;
    var filtered = geojsonData.features.filter(function(f) {
      var props = f.properties || {};
      var matchDistrict = !window._selectedFilterDistricts || window._selectedFilterDistricts.length === 0 || window._selectedFilterDistricts.includes(props.District_KGIS);
      var matchTaluk = !window._selectedFilterTaluks || window._selectedFilterTaluks.length === 0 || window._selectedFilterTaluks.includes(props.Taluk_KGIS);
      return matchDistrict && matchTaluk;
    });
    layerObj.addData({type:'FeatureCollection',features:filtered});
  });
};
    // Improved responsive resize for query-section to handle right panel overlap
function resizeQuerySection() {
  var leftPanel = document.getElementById('panelLeft');
  var rightPanel = document.getElementById('panelRight');
  var querySection = document.getElementById('query-section');
  var leftWidth = (leftPanel && (leftPanel.style.left === '0px' || leftPanel.style.left === '')) ? 320 : 0;
  var rightWidth = (rightPanel && (rightPanel.style.right === '0px' || rightPanel.style.right === '')) ? 320 : 0;
  if (querySection) {
    querySection.style.marginLeft = leftWidth + 'px';
    querySection.style.marginRight = rightWidth + 'px';
    // Also set width to avoid overlap
    var container = document.getElementById('mainContent');
    if (container) {
      var totalWidth = container.offsetWidth;
      querySection.style.width = (totalWidth - leftWidth - rightWidth) + 'px';
    }
  }
}
// Listen for panel expand/collapse
var leftPanel = document.getElementById('panelLeft');
var leftToggle = document.getElementById('panelLeftToggle');
if (leftToggle) {
  leftToggle.addEventListener('click', function() {
    setTimeout(resizeQuerySection, 300);
  });
}
var rightPanel = document.getElementById('panelRight');
var rightToggle = document.getElementById('panelRightToggle');
if (rightToggle) {
  rightToggle.addEventListener('click', function() {
    setTimeout(resizeQuerySection, 300);
  });
}
window.addEventListener('resize', resizeQuerySection);
// Initial call
resizeQuerySection();
  </script>
</body>
</html>
